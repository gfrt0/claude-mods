#!/bin/bash
# WSL toast notification via PowerShell/WPF.
# Adapted from https://github.com/wanyukang/claude-code-notify-hook-in-WSL (MIT license).

# Version configuration
SCRIPT_VERSION="1.2.2"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PS_SCRIPT="$SCRIPT_DIR/notify.ps1"

# Parameters
title="${1:-Claude Code}"
message="${2:-Notification}"

# Check and update PowerShell script
check_and_update_ps_script() {
    local need_update=false

    if [ ! -f "$PS_SCRIPT" ]; then
        need_update=true
    else
        local current_version=$(head -n 1 "$PS_SCRIPT" | grep -oP '(?<=Version: )\S+')
        if [ "$current_version" != "$SCRIPT_VERSION" ]; then
            need_update=true
        fi
    fi

    if [ "$need_update" = true ]; then
        cat > "$PS_SCRIPT" << 'PSEOF'
# Version: 1.2.2
param($title, $message)

try {
    Add-Type -AssemblyName PresentationFramework

    $xaml = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Notification" Height="140" Width="350"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        Topmost="True" ShowInTaskbar="False" ResizeMode="NoResize">
    <Border Background="#FFFFFF" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="8" Padding="0">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Background="#4CAF50" CornerRadius="8,0,0,8"/>

            <StackPanel Grid.Column="1" Margin="15">
                <TextBlock Text="$($title)" FontSize="16" FontWeight="Bold"
                           Foreground="#212121" Margin="0,0,0,10"/>
                <TextBlock Text="$($message)" FontSize="12"
                           Foreground="#757575" TextWrapping="Wrap"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>
"@

    $window = [Windows.Markup.XamlReader]::Parse($xaml)

    # Position window at top right
    $window.Left = [System.Windows.SystemParameters]::WorkArea.Right - $window.Width - 20
    $window.Top = 20

    # Set initial opacity to 0 for fade-in
    $window.Opacity = 0

    # Use a single timer to handle all animations
    $animationStep = 0
    $mainTimer = New-Object System.Windows.Threading.DispatcherTimer
    $mainTimer.Interval = New-Object TimeSpan(0,0,0,0,20)
    $mainTimer.Add_Tick({
        $script:animationStep++

        # Fade-in phase (0-25 steps = 0.5 seconds)
        if ($script:animationStep -le 25) {
            $window.Opacity = $script:animationStep / 25.0
        }
        # Wait phase (26-100 steps = 1.5 seconds)
        elseif ($script:animationStep -le 100) {
            $window.Opacity = 1.0
        }
        # Fade-out phase (101-125 steps = 0.5 seconds)
        elseif ($script:animationStep -le 125) {
            $remaining = 125 - $script:animationStep
            $window.Opacity = $remaining / 25.0
        }
        # Close window
        else {
            $mainTimer.Stop()
            $window.Close()
        }
    })

    $mainTimer.Start()

    try {
        $window.ShowDialog() | Out-Null
    } catch {
        # Silently ignore errors on close
    }

} catch {
    Write-Host "Error: $_"
    Write-Host $_.Exception.Message
}
PSEOF
    fi
}

# Execute version check and update
check_and_update_ps_script

# Launch PowerShell to display notification
powershell.exe -ExecutionPolicy Bypass -File "$(wslpath -w "$PS_SCRIPT")" -title "$title" -message "$message"

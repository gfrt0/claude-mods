#!/bin/bash
# WSL toast notification via PowerShell/WPF.
# Adapted from https://github.com/wanyukang/claude-code-notify-hook-in-WSL (MIT license).

# Version configuration
SCRIPT_VERSION="1.3.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PS_SCRIPT="$SCRIPT_DIR/notify.ps1"

# Parameters
title="${1:-Claude Code}"
message="${2:-Notification}"

# Check and update PowerShell script
check_and_update_ps_script() {
    local need_update=false

    if [ ! -f "$PS_SCRIPT" ]; then
        need_update=true
    else
        local current_version=$(head -n 1 "$PS_SCRIPT" | grep -oP '(?<=Version: )\S+')
        if [ "$current_version" != "$SCRIPT_VERSION" ]; then
            need_update=true
        fi
    fi

    if [ "$need_update" = true ]; then
        cat > "$PS_SCRIPT" << 'PSEOF'
# Version: 1.3.0
param($title, $message)

Add-Type -AssemblyName PresentationFramework

$xaml = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Notification" Height="140" Width="350"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        Topmost="True" ShowInTaskbar="False" ShowActivated="False" ResizeMode="NoResize">
    <Border Background="#FFFFFF" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="8" Padding="0">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Background="#4CAF50" CornerRadius="8,0,0,8"/>
            <StackPanel Grid.Column="1" Margin="15">
                <TextBlock Text="$($title)" FontSize="16" FontWeight="Bold"
                           Foreground="#212121" Margin="0,0,0,10"/>
                <TextBlock Text="$($message)" FontSize="12"
                           Foreground="#757575" TextWrapping="Wrap"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>
"@

$window = [Windows.Markup.XamlReader]::Parse($xaml)

# Position at top right of screen
$window.Left = [System.Windows.SystemParameters]::WorkArea.Right - $window.Width - 20
$window.Top = 20
$window.Opacity = 0

# Animation timer: fade in (0.5s) -> hold (1.5s) -> fade out (0.5s) -> close
$step = 0
$timer = New-Object System.Windows.Threading.DispatcherTimer
$timer.Interval = [TimeSpan]::FromMilliseconds(20)
$timer.Add_Tick({
    $script:step++
    if ($script:step -le 25) {
        $window.Opacity = $script:step / 25.0
    } elseif ($script:step -le 100) {
        $window.Opacity = 1.0
    } elseif ($script:step -le 125) {
        $window.Opacity = (125 - $script:step) / 25.0
    } else {
        $timer.Stop()
        $window.Close()
    }
})
$timer.Start()

# Show without stealing focus; keep dispatcher alive until closed
$window.Show()
$window.Add_Closed({ [System.Windows.Threading.Dispatcher]::ExitAllFrames() })
[System.Windows.Threading.Dispatcher]::Run()
PSEOF
    fi
}

# Execute version check and update
check_and_update_ps_script

# Launch PowerShell to display notification
powershell.exe -ExecutionPolicy Bypass -File "$(wslpath -w "$PS_SCRIPT")" -title "$title" -message "$message"
